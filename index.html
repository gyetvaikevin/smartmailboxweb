<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Cognito IoT minimal test</title>
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1489.0.min.js"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
<script>
const REGION = 'eu-central-1';
const IDENTITY_POOL_ID = 'eu-central-1:2024f636-2cea-4e5a-964a-e2ee1b2615fb';
const IOT_ENDPOINT = 'aw0jttguq1qsu-ats.iot.eu-central-1.amazonaws.com';

AWS.config.region = REGION;

async function getGuestCredentials() {
  AWS.config.credentials = new AWS.CognitoIdentityCredentials({
    IdentityPoolId: IDENTITY_POOL_ID
  });
  AWS.config.credentials.clearCachedId();
  return new Promise((resolve, reject) => {
    AWS.config.credentials.get(err => {
      if (err) return reject(err);
      resolve(AWS.config.credentials);
    });
  });
}

function createPresignedUrl(host, region, credentials) {
  const url = AWS.util.urlParse(`wss://${host}/mqtt`);
  const request = new AWS.HttpRequest(url, region);
  request.method = 'GET';
  request.path = '/mqtt';
  const signer = new AWS.Signers.V4(request, 'iotdevicegateway');
  signer.addAuthorization(credentials, AWS.util.date.getDate());
  const query = [];
  for (let key in request.headers) {
    if (key.startsWith('X-Amz-')) {
      query.push(`${encodeURIComponent(key)}=${encodeURIComponent(request.headers[key])}`);
    }
  }
  return `wss://${host}/mqtt?${query.join('&')}&X-Amz-Security-Token=${encodeURIComponent(credentials.sessionToken)}`;
}

(async () => {
  try {
    const creds = await getGuestCredentials();
    const identityId = creds.identityId;
    console.log('IdentityId:', identityId);
    console.log('AccessKeyId:', creds.accessKeyId);
    console.log('SecretAccessKey:', creds.secretAccessKey);
    console.log('SessionToken:', creds.sessionToken);
    console.log('ExpireTime:', creds.expireTime);

    const presignedUrl = createPresignedUrl(IOT_ENDPOINT, REGION, creds);

    const client = mqtt.connect(presignedUrl, {
      clientId: identityId, // fontos: egyezzen a policy Resource-szal
      protocolVersion: 4,
      clean: true,
      reconnectPeriod: 0
    });

    client.on('connect', () => {
      console.log('✅ MQTT connected');
      client.end();
    });

    client.on('error', err => {
      console.error('❌ MQTT error:', err);
    });

  } catch (e) {
    console.error('Init error:', e);
  }
})();
</script>
</body>
</html>
